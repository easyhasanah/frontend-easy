name: Next.js Frontend Deployment

on:
  push:
    branches: [ "aldin-cb" ]
  pull_request:
    branches: [ "aldin-cb" ]

jobs:
  build-and-deploy:
    runs-on: [self-hosted, Linux, X64]

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "18.x"

    - name: Downgrade to React 18
      run: |
        cd frontend-easy
        npm install react@18 react-dom@18 --save

    - name: Install dependencies
      run: npm install
      working-directory: ./frontend-easy

    - name: Build Next.js App (skip lint)
      run: npm run build -- --no-lint
      working-directory: ./frontend-easy

    - name: Stop frontend service (systemd)
      run: |
        echo "Stopping existing frontend service..."
        sudo systemctl stop easy-frontend.service || true

    - name: Adjust directory permissions
      run: |
        echo "Adjusting permissions..."
        sudo chown -R kelompok2:kelompok2 /home/kelompok2/frontend4/
        sudo chmod -R 755 /home/kelompok2/frontend4/

    - name: Deploy build output to server
      run: |
        echo "Deploying built output..."
        rm -rf /home/kelompok2/frontend4/*
        cp -r ./frontend-easy/.next /home/kelompok2/frontend4/
        cp -r ./frontend-easy/public /home/kelompok2/frontend4/
        cp ./frontend-easy/package.json /home/kelompok2/frontend4/
        cp ./frontend-easy/package-lock.json /home/kelompok2/frontend4/
        cp ./frontend-easy/next.config.ts /home/kelompok2/frontend4/

    - name: Restart frontend service (systemd)
      run: |
        echo "Restarting easy-frontend.service..."
        sudo systemctl start easy-frontend.service
        sleep 5

    - name: Check frontend app
      run: |
        curl http://192.168.23.50:3000 || true

    - name: Show frontend log on failure
      if: failure()
      run: |
        journalctl -u easy-frontend.service --no-pager -n 50 || true
