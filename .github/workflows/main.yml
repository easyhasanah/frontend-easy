name: Next.js Frontend Deployment

on:
  push:
    branches: [ "workflow" ]
  pull_request:
    branches: [ "workflow" ]

jobs:
  build-and-deploy:
    runs-on: [self-hosted, Linux, X64]

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "18.x"

    - name: Downgrade to React 18
      run: |
        cd frontend-easy
        npm install react@18 react-dom@18 --save

    - name: Install dependencies
      run: npm install
      working-directory: ./frontend-easy

    - name: Build Next.js App
      run: npm run build
      working-directory: ./frontend-easy

    - name: Stop existing frontend service (if any)
      run: |
        echo "Stopping existing frontend service..."
        pkill -f "node /home/kelompok2/frontend4/.next/standalone/server.js" || true
        sleep 5

    - name: Adjust permissions for production directory
      run: |
        echo "Adjusting permissions for /home/kelompok2/frontend4/"
        sudo chown -R kelompok2:kelompok2 /home/kelompok2/frontend4/
        sudo chmod -R 755 /home/kelompok2/frontend4/

    - name: Deploy build output
      run: |
        echo "Deploying frontend build..."
        rm -rf /home/kelompok2/frontend4/*
        cp -r ./frontend-easy/. /home/kelompok2/frontend4/

    - name: Start frontend server
      run: |
        echo "Starting frontend app..."
        cd /home/kelompok2/frontend4/
        nohup npm start &

    - name: Check frontend app status
      run: |
        echo "Checking frontend status..."
        curl http://192.168.23.50:3000 || true

    - name: Show frontend log on failure
      if: failure()
      run: |
        echo "--- Frontend Log (if available) ---"
        tail -n 50 /home/kelompok2/frontend4/log.txt || true
